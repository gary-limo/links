WITH RECURSIVE pattern_extract AS (
    -- Split query_text into words and extract potential schema.table patterns
    SELECT 
        REGEXP_SUBSTR(query_text, 'schema\\.table[_]?', 1, ROW_NUMBER() OVER (ORDER BY (SELECT NULL))) as pattern
    FROM your_table  -- Replace with your actual table name
    WHERE pattern IS NOT NULL
    QUALIFY ROW_NUMBER() OVER (ORDER BY (SELECT NULL)) <= 
            REGEXP_COUNT(query_text, 'schema\\.table[_]?')
)
SELECT DISTINCT 
    pattern
FROM pattern_extract p1
WHERE 
    -- Exclude patterns ending with underscore unless there's a matching pattern without underscore
    (NOT ENDSWITH(pattern, '_') 
    OR 
    EXISTS (
        SELECT 1 
        FROM pattern_extract p2 
        WHERE RTRIM(p1.pattern, '_') = p2.pattern
    ))
ORDER BY pattern;
